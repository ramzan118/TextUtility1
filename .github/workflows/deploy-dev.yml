name: Deploy to Production  # Updated workflow name

on:
  push:
    branches: [aksremote]

env:
  VM_IP: ${{ secrets.VM_IP_ADDRESS }}  # Fixed VM_IP reference
  SSH_KEY: ${{ secrets.SSH_KEY }}

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t textutility:$GITHUB_SHA .

      - name: Deploy to VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VM_IP }}  # Fixed VM_IP reference
          username: azureuser
          key: ${{ env.SSH_KEY }}
          script: |
            docker stop blue || true
            docker stop green || true
            docker run -d --rm -p 8080:80 --name green textutility:$GITHUB_SHA
            sleep 10
            docker run -d --rm -p 8081:80 --name blue textutility:$GITHUB_SHA
            docker exec blue curl -Is http://localhost:80 | head -1
            docker exec green curl -Is http://localhost:80 | head -1
            sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
